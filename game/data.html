<!doctype html>
<html>

<head>
    <meta name="theme-color" content="#f2f2f2">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>联通流量</title>
</head>

<body style="background: #f2f2f2;">
    <script src="https://lib.sinaapp.com/js/jquery/1.8.3/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/highcharts/4.2.6/highcharts.js"></script>
    <center class="input">
        <textarea class="text" style="color:#999; font-size:1.2em; line-height:1.5em; width: 90%; max-width: 90%; height: 10em; border: 0; background-color: #f2f2f2; ">

        使用方法： 
        1、点击“查询按钮”拨打电话； 
        2、将收到的短信复制到此文本框； 
        3、点击“统计”按钮查询可视化结果。
        </textarea>
        <br/>
        <br/>
         <a href="tel:1001011" style=" text-decoration: none;"><font style="border: 0; background-color: #2ecc71; color: #fff; padding: 0.5em 1em 0.5em 1em; font-size:1em; border-radius: 0.5em;">查询</font></a>
        <font class="submit" style="border: 0; background-color: #2ecc71; color: #fff; padding: 0.5em 1em 0.5em 1em; font-size:1em; border-radius: 0.5em;">统计</font>
    </center>
    <center>
        <div id="container" style="min-width:300px;height:480px;margin:2em;"></div>
        <script type="text/javascript">
        //var used = [];
        //var unused = [];
        var data = [];
        var used = [0, 0, 0, 0, 0];
        var unused = [0, 0, 0, 0, 0];
        $(".text").click(function(){
            $(".text").val('');
        });
        var cutData = function(str, n) {
            if (n === 0) { //获取数字
                if (str.indexOf("KB") > 0) {
                    //console.log(str.replace(/[^0-9\.]/ig, ""));
                    //                      /[^0-9]/ig
                    return (Number(str.replace(/[^0-9\.]/ig, "")) / 1024);
                } else if (str.indexOf("GB") > 0) {
                    //console.log(str.replace(/[^0-9\.]/ig, ""));
                    return (Number(str.replace(/[^0-9\.]/ig, "")) * 1024);
                } else {
                    //console.log(str.replace(/[^0-9\.]/ig, ""));
                    return Number(str.replace(/[^0-9\.]/ig, ""));
                }
            } else if (n === 1) { //删除第一项多余的
                //return str.replace(["优惠累计量", "的", "KB", "GB", "MB", "，", "已使用", "剩余"], "");
                return str.replace("优惠累计量", "").replace("的", "").replace("已使用", "").replace("剩余", "").replace("，", "").replace("KB", "").replace("MB", "").replace("GB", "");
            } else {
                alert("次要参数错误！");
            }
        };
        var getData = function(text) {
            var textS = text.split("；");
            for (i = 0; i <= textS.length - 2; i++) {
                //console.log(textS[i]);
                data.push([]);
                data[i].push(cutData(textS[i].split("，")[0].substring(0, textS[i].split("，")[0].indexOf("优惠累计")), 1));
                data[i].push(cutData(textS[i].split("，")[1], 0));
                data[i].push(cutData(textS[i].split("，")[2], 0));
                console.log(data[i]);
            };
            return text;
        }
        var findGet = function(text) {
            //var str = '截至当前';
            var strLength = text.length;
            //console.log(text);
            text = text.substring(text.indexOf("截至当前") + 7, text.indexOf("本地主叫"));
            //console.log(text);
            getData(text);
            for (i = 0; i <= data.length - 1; i++) {
                if (data[i][0].indexOf("闲时") >= 0) {
                    used[3] = used[3] + data[i][1];
                    unused[3] = unused[3] + data[i][2];
                } else if (data[i][0].indexOf("闲时") < 0 && data[i][0].indexOf("本地") >= 0) {
                    used[0] = used[0] + data[i][1];
                    unused[0] = unused[0] + data[i][2];
                } else if (data[i][0].indexOf("定向") >= 0) {
                    used[4] = used[4] + data[i][1];
                    unused[4] = unused[4] + data[i][2];
                } else if (data[i][0].indexOf("结转") >= 0) {
                    used[1] = used[1] + data[i][1];
                    unused[1] = unused[1] + data[i][2];
                } else {
                    used[2] = used[2] + data[i][1];
                    unused[2] = unused[2] + data[i][2];
                }
            }
            return text;
        }

        $('.submit').click(function() {
            findGet(String($(".text").val()));
            $(".input").hide();
            $(function() {
                $('#container').highcharts({
                    chart: {
                        type: 'bar',
                        backgroundColor: '#f2f2f2',
                        plotBackgroundColor: '#f2f2f2',
                        plotBorderWidth: null,
                        plotShadow: false,
                    },
                    colors: ['#2ecc71', '#9c9c9c'],
                    title: {
                        text: '流量情况'
                    },
                    credits: {
                        enabled: false // 禁用版权信息
                    },
                    tooltip: {
 					   valueSuffix: ' M'
					},
                    xAxis: {
                        categories: ['本地', '结转', '全国', '闲时', '定向']
                    },
                    yAxis: {
                        min: 0,
                        title: null
                    },
                    legend: {
                        reversed: true
                    },
                    plotOptions: {
                        series: {
                            stacking: 'normal'
                        }
                    },
                    series: [{
                        name: '剩余',
                        data: unused
                    }, {
                        name: '已用',
                        data: used
                    }]
                });
            });
        });
        </script>
    </center>
</body>

</html>
